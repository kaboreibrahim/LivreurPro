 {% extends 'base.html' %}
{% block page_name %}Nouvelle Demande de Livraison{% endblock %}
{% block content %}
{% load static %}

<style>
Â  Â  /* DÃ©finition des Variables */
Â  Â  :root {
Â  Â  Â  Â  --primary: #000080; /* Bleu Marine */
Â  Â  Â  Â  --secondary: #FF6B00; /* Orange Vif */
Â  Â  Â  Â  --light: #FFF9E5;
Â  Â  Â  Â  --dark: #1A1A1A;
Â  Â  Â  Â  --success-color: #28a745;
Â  Â  Â  Â  --danger-color: #dc3545;
Â  Â  }
Â  Â  
Â  Â  #map {
Â  Â  Â  Â  height: 500px;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
Â  Â  }
Â  Â  
Â  Â  .search-container {
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  }
Â  Â  
Â  Â  .search-input-wrapper {
Â  Â  Â  Â  position: relative;
Â  Â  }
Â  Â  
Â  Â  .search-input-wrapper input {
Â  Â  Â  Â  padding-right: 45px;
Â  Â  }
Â  Â  
Â  Â  .location-btn {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  right: 10px;
Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  transform: translateY(-50%);
Â  Â  Â  Â  background: var(--secondary);
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  width: 35px;
Â  Â  Â  Â  height: 35px;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: all 0.3s;
Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  font-size: 18px; /* Taille de l'icÃ´ne ğŸ¯ */
Â  Â  }
Â  Â  
Â  Â  .location-btn:hover {
Â  Â  Â  Â  background: #e55f00;
Â  Â  Â  Â  transform: translateY(-50%) scale(1.1);
Â  Â  }
Â  Â  
Â  Â  .location-btn:active {
Â  Â  Â  Â  transform: translateY(-50%) scale(0.95);
Â  Â  }
Â  Â  
Â  Â  .suggestions-list {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 100%;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  background: white;
Â  Â  Â  Â  border: 2px solid var(--primary);
Â  Â  Â  Â  border-top: none;
Â  Â  Â  Â  max-height: 300px;
Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  box-shadow: 0 8px 16px rgba(0, 0, 128, 0.15);
Â  Â  Â  Â  border-radius: 0 0 12px 12px;
Â  Â  Â  Â  display: none;
Â  Â  }
Â  Â  
Â  Â  .suggestion-item {
Â  Â  Â  Â  padding: 15px 20px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  border-bottom: 1px solid var(--light);
Â  Â  Â  Â  transition: all 0.2s;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: start;
Â  Â  Â  Â  gap: 12px;
Â  Â  }
Â  Â  
Â  Â  .suggestion-item:hover {
Â  Â  Â  Â  background-color: var(--light);
Â  Â  Â  Â  padding-left: 25px;
Â  Â  }
Â  Â  
Â  Â  .suggestion-icon {
Â  Â  Â  Â  color: var(--primary);
Â  Â  Â  Â  font-size: 18px;
Â  Â  Â  Â  margin-top: 2px;
Â  Â  Â  Â  flex-shrink: 0;
Â  Â  }
Â  Â  
Â  Â  .suggestion-content {
Â  Â  Â  Â  flex: 1;
Â  Â  }
Â  Â  
Â  Â  .suggestion-title {
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  margin-bottom: 2px;
Â  Â  }
Â  Â  
Â  Â  .suggestion-subtitle {
Â  Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  Â  color: #666;
Â  Â  }
Â  Â  
Â  Â  .info-distance {
Â  Â  Â  Â  background: linear-gradient(135deg, var(--primary), #0000b8);
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  padding: 15px 25px;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 128, 0.2);
Â  Â  }
Â  Â  
Â  Â  .info-distance-icon {
Â  Â  Â  Â  font-size: 24px;
Â  Â  }
Â  Â  
Â  Â  .card {
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
Â  Â  Â  Â  margin-bottom: 25px;
Â  Â  }
Â  Â  
Â  Â  .card-header {
Â  Â  Â  Â  background: linear-gradient(135deg, var(--primary), #0000b8);
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  border-radius: 12px 12px 0 0 !important;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  border: none;
Â  Â  }
Â  Â  
Â  Â  .card-header h5 {
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â  
Â  Â  .form-control, .form-select {
Â  Â  Â  Â  border: 2px solid #e0e0e0;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  padding: 12px 15px;
Â  Â  Â  Â  transition: all 0.3s;
Â  Â  }
Â  Â  
Â  Â  .form-control:focus, .form-select:focus {
Â  Â  Â  Â  border-color: var(--primary);
Â  Â  Â  Â  box-shadow: 0 0 0 0.2rem rgba(0, 0, 128, 0.15);
Â  Â  }
Â  Â  
Â  Â  .form-label {
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  color: var(--dark);
Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  }
Â  Â  
Â  Â  .btn-primary {
Â  Â  Â  Â  background: linear-gradient(135deg, var(--secondary), #ff8533);
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  padding: 15px 30px;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  transition: all 0.3s;
Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
Â  Â  }
Â  Â  
Â  Â  .btn-primary:hover {
Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(255, 107, 0, 0.4);
Â  Â  Â  Â  background: linear-gradient(135deg, #ff8533, var(--secondary));
Â  Â  }
Â  Â  
Â  Â  .loading-spinner {
Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  width: 16px;
Â  Â  Â  Â  height: 16px;
Â  Â  Â  Â  border: 2px solid white;
Â  Â  Â  Â  border-top-color: transparent;
Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  animation: spin 0.6s linear infinite;
Â  Â  Â  Â  margin-left: 8px;
Â  Â  }
Â  Â  
Â  Â  @keyframes spin {
Â  Â  Â  Â  to { transform: rotate(360deg); }
Â  Â  }
Â  Â  
Â  Â  .marker-popup {
Â  Â  Â  Â  font-size: 13px;
Â  Â  }
Â  Â  
Â  Â  .marker-popup strong {
Â  Â  Â  Â  color: var(--primary);
Â  Â  }
Â  Â  
Â  Â  /* Style pour les markers draggables */
Â  Â  .mapboxgl-marker {
Â  Â  Â  Â  cursor: move !important;
Â  Â  }
Â  Â  
Â  Â  .search-loading {
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  color: var(--primary);
Â  Â  }
Â  Â  
Â  Â  .no-results {
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  color: #999;
Â  Â  }

Â  Â  /* Styles spÃ©cifiques pour les Marqueurs (SVG amÃ©liorÃ©) */
Â  Â  .marker-depart, .marker-destination {
Â  Â  Â  Â  width: 40px;
Â  Â  Â  Â  height: 40px;
Â  Â  }
Â  Â  
Â  Â  /* DÃ©but: Vert/Bleu */
Â  Â  .marker-depart svg circle { fill: var(--success-color); }
Â  Â  .marker-depart svg text { font-size: 24px; }

Â  Â  /* Destination: Rouge/Orange */
Â  Â  .marker-destination svg circle { fill: var(--danger-color); }
Â  Â  .marker-destination svg text { font-size: 24px; }
Â  Â  
</style>

<div class="container mt-4">
Â  Â  <div class="row">
Â  Â  Â  Â  <div class="col-12">
Â  Â  Â  Â  Â  Â  <h2 class="mb-4" style="color: var(--primary); font-weight: 700;">ğŸ“¦ Nouvelle Demande de Livraison</h2>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  {% if messages %}
Â  Â  Â  Â  Â  Â  Â  Â  {% for message in messages %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ message }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <form method="post" enctype="multipart/form-data" id="dcl-form">
Â  Â  Â  Â  Â  Â  Â  Â  {% csrf_token %}
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5>ğŸ“ Localisation de la livraison</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="map"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="info-distance" class="info-distance" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="info-distance-icon">ğŸ“</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 0.9rem; opacity: 0.9;">Distance estimÃ©e</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 1.3rem;"><span id="distance-value">-</span> km</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="search-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">ğŸŸ¢ Adresse de dÃ©part</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="search-input-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â id="search-depart" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="form-control" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â placeholder="Rechercher ou utiliser ma position actuelle...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="location-btn" id="btn-my-location" title="Utiliser ma position actuelle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ¯ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="suggestions-depart" class="suggestions-list"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.adresse_depart }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.latitude_depart }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.longitude_depart }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="search-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">ğŸ”´ Adresse de destination</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="search-input-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â id="search-destination" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="form-control" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â placeholder="Rechercher une adresse de destination...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="suggestions-destination" class="suggestions-list"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.adresse_destination }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.latitude_destination }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.longitude_destination }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="alert alert-info" style="border-left: 4px solid var(--primary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ’¡ <strong>Astuce:</strong> Vous pouvez dÃ©placer les marqueurs (ğŸŸ¢ et ğŸ”´) sur la carte pour ajuster prÃ©cisÃ©ment les positions.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5>ğŸ“¦ Informations du Colis</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-body">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">ğŸ“ Contact Destinataire</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.Contact_destinateur }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">ğŸš— Type de course</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.type_course }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-12 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">ğŸ“ Description du colis</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.description_colis }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-4 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">âš–ï¸ Poids (kg)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.poids_colis }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-4 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">ğŸ’° Valeur (FCFA)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.valeur_colis }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-4 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">ğŸ“… Date de rÃ©cupÃ©ration</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.date_recuperation }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">ğŸ“· Photo du colis 1</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.photo_colis1 }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">ğŸ“· Photo du colis 2 (optionnel)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.photo_colis2 }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-12 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">ğŸ“‹ Instructions supplÃ©mentaires</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ form.instructions }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <div class="d-grid gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-primary btn-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸš€ CrÃ©er la demande de livraison
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />

<script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>

<script>
Â  Â  mapboxgl.accessToken = '{{ mapbox_token }}';
Â  Â  
Â  Â  // Initialiser la carte centrÃ©e sur Abidjan
Â  Â  const map = new mapboxgl.Map({
Â  Â  Â  Â  container: 'map',
Â  Â  Â  Â  style: 'mapbox://styles/mapbox/streets-v12',
Â  Â  Â  Â  center: [-4.0305, 5.3599], // Abidjan, CÃ´te d'Ivoire
Â  Â  Â  Â  zoom: 11
Â  Â  });
Â  Â  
Â  Â  // Ajouter les contrÃ´les de navigation
Â  Â  map.addControl(new mapboxgl.NavigationControl());
Â  Â  map.addControl(new mapboxgl.GeolocateControl({
Â  Â  Â  Â  positionOptions: {
Â  Â  Â  Â  Â  Â  enableHighAccuracy: true
Â  Â  Â  Â  },
Â  Â  Â  Â  trackUserLocation: true,
Â  Â  Â  Â  showUserHeading: true
Â  Â  }));
Â  Â  
Â  Â  // Markers et Route
Â  Â  let markerDepart = null;
Â  Â  let markerDestination = null;
Â  Â  window.suggestionMarkers = []; // Pour les marqueurs de recherche temporaires
Â  Â  
Â  Â  // Fonction pour obtenir la position actuelle du client
Â  Â  document.getElementById('btn-my-location').addEventListener('click', () => {
Â  Â  Â  Â  const btn = document.getElementById('btn-my-location');
Â  Â  Â  Â  btn.innerHTML = '<span class="loading-spinner"></span>';
Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  
Â  Â  Â  Â  if ('geolocation' in navigator) {
Â  Â  Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(
Â  Â  Â  Â  Â  Â  Â  Â  async (position) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { latitude, longitude } = position.coords;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // GÃ©ocodage inverse pour obtenir l'adresse
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `https://api.mapbox.com/geocoding/v5/mapbox.places/${longitude},${latitude}.json?` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `access_token=${mapboxgl.accessToken}&language=fr`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const address = data.features[0]?.place_name || 'Ma position actuelle';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Mettre Ã  jour les champs visible et cachÃ©s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('search-depart').value = address;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('adresse_depart').value = address;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('latitude_depart').value = latitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('longitude_depart').value = longitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CrÃ©er ou mettre Ã  jour le marker draggable
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createDraggableMarker(longitude, latitude, 'depart', address);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Centrer la carte
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.flyTo({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  center: [longitude, latitude],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  zoom: 15
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Calculer l'itinÃ©raire si destination existe
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  calculateRoute();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erreur gÃ©ocodage:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Impossible de rÃ©cupÃ©rer l\'adresse exacte');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.innerHTML = 'ğŸ¯';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erreur gÃ©olocalisation:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Impossible d\'accÃ©der Ã  votre position. VÃ©rifiez les autorisations.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.innerHTML = 'ğŸ¯';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert('La gÃ©olocalisation n\'est pas supportÃ©e par votre navigateur');
Â  Â  Â  Â  Â  Â  btn.innerHTML = 'ğŸ¯';
Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  // CrÃ©er un marker draggable
Â  Â  function createDraggableMarker(lng, lat, type, address) {
Â  Â  Â  Â  // IcÃ´nes de Marqueur personnalisÃ©es
Â  Â  Â  Â  const svgMarkup = (color, text) => `
Â  Â  Â  Â  Â  Â  <svg width="40" height="40" viewBox="0 0 40 40">
Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="20" cy="20" r="18" fill="${color}" stroke="white" stroke-width="3"/>
Â  Â  Â  Â  Â  Â  Â  Â  <text x="20" y="27" text-anchor="middle" fill="white" font-weight="bold" font-size="24">${text}</text>
Â  Â  Â  Â  Â  Â  </svg>`;

Â  Â  Â  Â  const el = document.createElement('div');
Â  Â  Â  Â  el.className = type === 'depart' ? 'marker-depart' : 'marker-destination';
Â  Â  Â  Â  el.innerHTML = type === 'depart' 
Â  Â  Â  Â  Â  Â  ? svgMarkup('var(--success-color)', 'A') // Vert pour DÃ©part
Â  Â  Â  Â  Â  Â  : svgMarkup('var(--danger-color)', 'B'); // Rouge pour Destination
Â  Â  Â  Â  
Â  Â  Â  Â  const marker = new mapboxgl.Marker({
Â  Â  Â  Â  Â  Â  element: el,
Â  Â  Â  Â  Â  Â  draggable: true
Â  Â  Â  Â  })
Â  Â  Â  Â  .setLngLat([lng, lat])
Â  Â  Â  Â  .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(
Â  Â  Â  Â  Â  Â  `<div class="marker-popup"><strong>${type === 'depart' ? 'DÃ©part' : 'Destination'}</strong><br>${address}</div>`
Â  Â  Â  Â  ))
Â  Â  Â  Â  .addTo(map);
Â  Â  Â  Â  
Â  Â  Â  Â  // Ã‰vÃ©nement de fin de drag
Â  Â  Â  Â  marker.on('dragend', async () => {
Â  Â  Â  Â  Â  Â  const lngLat = marker.getLngLat();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // GÃ©ocodage inverse
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `https://api.mapbox.com/geocoding/v5/mapbox.places/${lngLat.lng},${lngLat.lat}.json?` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `access_token=${mapboxgl.accessToken}&language=fr`
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  const newAddress = data.features[0]?.place_name || 'Position personnalisÃ©e';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Mettre Ã  jour les champs
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`search-${type}`).value = newAddress;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`adresse_${type}`).value = newAddress;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`latitude_${type}`).value = lngLat.lat;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`longitude_${type}`).value = lngLat.lng;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Mettre Ã  jour le popup
Â  Â  Â  Â  Â  Â  Â  Â  marker.setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<div class="marker-popup"><strong>${type === 'depart' ? 'DÃ©part' : 'Destination'}</strong><br>${newAddress}</div>`
Â  Â  Â  Â  Â  Â  Â  Â  ));
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Recalculer l'itinÃ©raire
Â  Â  Â  Â  Â  Â  Â  Â  calculateRoute();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erreur gÃ©ocodage:', error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  if (type === 'depart') {
Â  Â  Â  Â  Â  Â  if (markerDepart) markerDepart.remove();
Â  Â  Â  Â  Â  Â  markerDepart = marker;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  if (markerDestination) markerDestination.remove();
Â  Â  Â  Â  Â  Â  markerDestination = marker;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  return marker;
Â  Â  }
Â  Â  
Â  Â  // Fonction de recherche de lieux
Â  Â  async function searchPlace(query, type) {
Â  Â  Â  Â  // Nettoyer les marqueurs de suggestion prÃ©cÃ©dents
Â  Â  Â  Â  window.suggestionMarkers.forEach(m => m.remove());
Â  Â  Â  Â  window.suggestionMarkers = [];

Â  Â  Â  Â  if (query.length < 3) {
Â  Â  Â  Â  Â  Â  document.getElementById(`suggestions-${type}`).style.display = 'none';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  const suggestionsList = document.getElementById(`suggestions-${type}`);
Â  Â  Â  Â  suggestionsList.innerHTML = '<div class="search-loading">ğŸ” Recherche en cours...</div>';
Â  Â  Â  Â  suggestionsList.style.display = 'block';
Â  Â  Â  Â  
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(
Â  Â  Â  Â  Â  Â  Â  Â  `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?` +
Â  Â  Â  Â  Â  Â  Â  Â  `access_token=${mapboxgl.accessToken}&` +
Â  Â  Â  Â  Â  Â  Â  Â  `country=CI&` + // Cibler la CÃ´te d'Ivoire
Â  Â  Â  Â  Â  Â  Â  Â  `limit=10&` +
Â  Â  Â  Â  Â  Â  Â  Â  `language=fr`
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  displaySuggestions(data.features, type);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (data.features.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const bounds = new mapboxgl.LngLatBounds();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Afficher les marqueurs de suggestion et Ã©tendre la vue
Â  Â  Â  Â  Â  Â  Â  Â  data.features.forEach((feature, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bounds.extend(feature.center);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const el = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.style.width = '25px';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.style.height = '25px';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.style.borderRadius = '50%';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.style.background = type === 'depart' ? 'var(--success-color)' : 'var(--danger-color)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.style.opacity = '0.6';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.style.border = '2px solid white';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.style.cursor = 'pointer';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const suggestionMarker = new mapboxgl.Marker(el)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .setLngLat(feature.center)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .addTo(map);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Clic sur le marqueur de suggestion = sÃ©lection
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectPlace(feature, type);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.suggestionMarkers.push(suggestionMarker);
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // Ajuster la vue pour montrer tous les rÃ©sultats
Â  Â  Â  Â  Â  Â  Â  Â  map.fitBounds(bounds, { padding: 50, maxZoom: 14 });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Erreur de recherche:', error);
Â  Â  Â  Â  Â  Â  suggestionsList.innerHTML = '<div class="no-results">âŒ Erreur de recherche</div>';
Â  Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  // Afficher les suggestions
Â  Â  function displaySuggestions(features, type) {
Â  Â  Â  Â  const suggestionsList = document.getElementById(`suggestions-${type}`);
Â  Â  Â  Â  suggestionsList.innerHTML = '';
Â  Â  Â  Â  
Â  Â  Â  Â  if (features.length === 0) {
Â  Â  Â  Â  Â  Â  suggestionsList.innerHTML = '<div class="no-results">Aucun rÃ©sultat trouvÃ©</div>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  features.forEach(feature => {
Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  div.className = 'suggestion-item';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Logique d'icÃ´ne plus simple et UX-friendly
Â  Â  Â  Â  Â  Â  let icon = 'ğŸ“Œ';
Â  Â  Â  Â  Â  Â  if (feature.place_type.includes('address')) icon = 'ğŸ ';
Â  Â  Â  Â  Â  Â  else if (feature.place_type.includes('locality')) icon = 'ğŸ™ï¸';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <span class="suggestion-icon">${icon}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="suggestion-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="suggestion-title">${feature.text}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="suggestion-subtitle">${feature.place_name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  div.onclick = () => selectPlace(feature, type);
Â  Â  Â  Â  Â  Â  suggestionsList.appendChild(div);
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  suggestionsList.style.display = 'block';
Â  Â  }
Â  Â  
Â  Â  // SÃ©lectionner un lieu
Â  Â  function selectPlace(feature, type) {
Â  Â  Â  Â  const [lng, lat] = feature.center;
Â  Â  Â  Â  const address = feature.place_name;
Â  Â  Â  Â  
Â  Â  Â  Â  // Mettre Ã  jour les champs
Â  Â  Â  Â  document.getElementById(`search-${type}`).value = feature.text; // Affiche le nom court du lieu dans l'input visible
Â  Â  Â  Â  document.getElementById(`adresse_${type}`).value = address;
Â  Â  Â  Â  document.getElementById(`latitude_${type}`).value = lat;
Â  Â  Â  Â  document.getElementById(`longitude_${type}`).value = lng;
Â  Â  Â  Â  
Â  Â  Â  Â  // Cacher les suggestions et supprimer les markers de suggestion
Â  Â  Â  Â  document.getElementById(`suggestions-${type}`).style.display = 'none';
Â  Â  Â  Â  
Â  Â  Â  Â  window.suggestionMarkers.forEach(m => m.remove());
Â  Â  Â  Â  window.suggestionMarkers = [];
Â  Â  Â  Â  
Â  Â  Â  Â  // CrÃ©er le marker draggable
Â  Â  Â  Â  createDraggableMarker(lng, lat, type, address);
Â  Â  Â  Â  
Â  Â  Â  Â  // Centrer la carte
Â  Â  Â  Â  map.flyTo({
Â  Â  Â  Â  Â  Â  center: [lng, lat],
Â  Â  Â  Â  Â  Â  zoom: 14
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  // Calculer l'itinÃ©raire
Â  Â  Â  Â  calculateRoute();
Â  Â  }
Â  Â  
Â  Â  // Calculer l'itinÃ©raire
Â  Â  async function calculateRoute() {
Â  Â  Â  Â  const departLng = document.getElementById('longitude_depart').value;
Â  Â  Â  Â  const departLat = document.getElementById('latitude_depart').value;
Â  Â  Â  Â  const destLng = document.getElementById('longitude_destination').value;
Â  Â  Â  Â  const destLat = document.getElementById('latitude_destination').value;
Â  Â  Â  Â  
Â  Â  Â  Â  const infoDistanceDiv = document.getElementById('info-distance');
Â  Â  Â  Â  const distanceValueSpan = document.getElementById('distance-value');
Â  Â  Â  Â  
Â  Â  Â  Â  if (!departLng || !destLng) {
Â  Â  Â  Â  Â  Â  if (map.getLayer('route')) map.removeLayer('route');
Â  Â  Â  Â  Â  Â  if (map.getSource('route')) map.removeSource('route');
Â  Â  Â  Â  Â  Â  infoDistanceDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(
Â  Â  Â  Â  Â  Â  Â  Â  `https://api.mapbox.com/directions/v5/mapbox/driving/${departLng},${departLat};${destLng},${destLat}?` +
Â  Â  Â  Â  Â  Â  Â  Â  `geometries=geojson&` +
Â  Â  Â  Â  Â  Â  Â  Â  `access_token=${mapboxgl.accessToken}`
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  const route = data.routes[0];
Â  Â  Â  Â  Â  Â  const distance = (route.distance / 1000).toFixed(2); // Convertir en km
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Afficher la distance
Â  Â  Â  Â  Â  Â  distanceValueSpan.textContent = distance;
Â  Â  Â  Â  Â  Â  infoDistanceDiv.style.display = 'flex';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Dessiner l'itinÃ©raire
Â  Â  Â  Â  Â  Â  const routeSourceData = {
Â  Â  Â  Â  Â  Â  Â  Â  type: 'Feature',
Â  Â  Â  Â  Â  Â  Â  Â  properties: {},
Â  Â  Â  Â  Â  Â  Â  Â  geometry: route.geometry
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (map.getSource('route')) {
Â  Â  Â  Â  Â  Â  Â  Â  map.getSource('route').setData(routeSourceData);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  map.addLayer({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: 'route',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'line',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  source: { type: 'geojson', data: routeSourceData },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  layout: { 'line-join': 'round', 'line-cap': 'round' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  paint: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'line-color': 'var(--secondary)', // Orange pour l'itinÃ©raire
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'line-width': 5,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'line-opacity': 0.75
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Ajuster la vue pour voir l'itinÃ©raire complet
Â  Â  Â  Â  Â  Â  const coordinates = route.geometry.coordinates;
Â  Â  Â  Â  Â  Â  const bounds = coordinates.reduce((bounds, coord) => {
Â  Â  Â  Â  Â  Â  Â  Â  return bounds.extend(coord);
Â  Â  Â  Â  Â  Â  }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  map.fitBounds(bounds, { padding: 50 });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Erreur calcul itinÃ©raire:', error);
Â  Â  Â  Â  Â  Â  // Cacher l'info distance en cas d'erreur
Â  Â  Â  Â  Â  Â  infoDistanceDiv.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  // Ã‰vÃ©nements de recherche avec debounce
Â  Â  let searchTimeout;
Â  Â  
Â  Â  document.getElementById('search-depart').addEventListener('input', (e) => {
Â  Â  Â  Â  clearTimeout(searchTimeout);
Â  Â  Â  Â  searchTimeout = setTimeout(() => {
Â  Â  Â  Â  Â  Â  searchPlace(e.target.value, 'depart');
Â  Â  Â  Â  }, 500);
Â  Â  });
Â  Â  
Â  Â  document.getElementById('search-destination').addEventListener('input', (e) => {
Â  Â  Â  Â  clearTimeout(searchTimeout);
Â  Â  Â  Â  searchTimeout = setTimeout(() => {
Â  Â  Â  Â  Â  Â  searchPlace(e.target.value, 'destination');
Â  Â  Â  Â  }, 500);
Â  Â  });
Â  Â  
Â  Â  // Fermer les suggestions et nettoyer les marqueurs de suggestion
Â  Â  document.addEventListener('click', (e) => {
Â  Â  Â  Â  if (!e.target.closest('.search-container')) {
Â  Â  Â  Â  Â  Â  document.getElementById('suggestions-depart').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('suggestions-destination').style.display = 'none';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Supprimer les markers de suggestion
Â  Â  Â  Â  Â  Â  window.suggestionMarkers.forEach(m => m.remove());
Â  Â  Â  Â  Â  Â  window.suggestionMarkers = [];
Â  Â  Â  Â  }
Â  Â  });
</script>

{% endblock %}